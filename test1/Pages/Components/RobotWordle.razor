@using System.Collections.Generic
@using WordleGuesser
@using WordleGuesser.Classes
@using test1.Pages.Components
@using Microsoft.AspNetCore.Components.Web
@using test1.Wordle.Classes;
@inject Stats stats

<div class="@IsHidden()" style=" padding:8px; background:#f3f3f3; border-radius:6px;">
    @for (int r = 0; r < 6; r++)
    {
        <div class="row">
            @for (int c = 0; c < 5; c++)
            {
                var ch = GetCellChar(r, c);
                var color = GetCellColor(r, c);
                <div class="tile @GetTileClass(color)">
                    @ch
                </div>
            }
        </div>
    }
</div>

<style>
    .hide{
		display: none;
    }
    .unhide{
        display: contents;
    }
    .row {
        display: flex;
        gap: 6px;
        margin: 6px 0;
        justify-content: center;
    }
    .tile {
        width: 48px;
        height: 48px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: 700;
        font-size: 20px;
        border-radius: 6px;
        background: var(--extra-light-gray, #e9e9e9);
        color: var(--wordleBlack, #212121);
        border: 2px solid rgba(0,0,0,0.06);
        text-transform: uppercase;
    }

        .tile.correct {
            background: #6aaa64;
            color: white;
        }

        .tile.present {
            background: #c9b458;
            color: white;
        }

        .tile.grey {
            background: #787c7e;
            color: white;
        }
</style>


@code {
    private ElementReference ContainerRef;
    private bool _shouldFocus;

    [Parameter]
    public string Solution { get; set; }
    [Parameter]
    public bool Hide { get; set; }

    private int CurrentRow { get; set; } = 0;
    private string CurrentGuess { get; set; } = "";
    private List<WordGuessResponse?> Guesses { get; set; } = new();
    private string StatusMessage { get; set; } = "";

    private Dictionary<string, PlayerKeyboard.KeyState> KeyStates { get; set; } = new();

    protected override async Task OnInitializedAsync()
    {
        _ = AutoSolve(); // fire-and-forget
    }

    private string IsHidden()
    {
        if (Hide)
            return "hide";

        return "unhide";
    }
    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        //_ = AutoSolve();
    }

    private void StartNewGame()
    {
        Solution = (Solution ?? "").Trim().ToLowerInvariant();

        CurrentRow = 0;
        CurrentGuess = "";
        StatusMessage = "";
        Guesses = Enumerable.Repeat<WordGuessResponse?>(null, 6).ToList();

        KeyStates = "abcdefghijklmnopqrstuvwxyz".ToDictionary(c => c.ToString(), c => PlayerKeyboard.KeyState.Default);
        _shouldFocus = true;
    }

    private bool IsGameOver() => CurrentRow >= 6;

    // Guarded: check bounds and nulls before indexing Guesses
    private char GetCellChar(int row, int col)
    {
        if (row < 0 || col < 0) return ' ';

        if (row < Guesses.Count && Guesses[row] != null)
        {
            var word = Guesses[row]!.Word;
            if (!string.IsNullOrEmpty(word) && col < word.Length)
                return char.ToUpperInvariant(word[col]);
            return ' ';
        }
        else if (row == CurrentRow && col < CurrentGuess.Length)
            return char.ToUpperInvariant(CurrentGuess[col]);

        return ' ';
    }

    // Guarded: ensure Colors list exists and index is in range
    private ResponseColor? GetCellColor(int row, int col)
    {
        if (row < 0 || col < 0) return null;

        if (row < Guesses.Count && Guesses[row] != null)
        {
            var colors = Guesses[row]!.Colors;
            if (colors != null && col < colors.Count)
                return colors[col];
        }

        return null;
    }

    private string GetTileClass(ResponseColor? color)
    {
        return color switch
        {
            ResponseColor.green => "correct",
            ResponseColor.yellow => "present",
            ResponseColor.grey => "grey",
            _ => ""
        };
    }


    private async Task AutoSolve()
    {
        try
        {
            var g = new Guesser(Solution);
            var guesses = g.FailedGuesses ?? new List<WordGuessResponse>();

            StartNewGame();
            int i = 0;
            foreach (var guess in guesses)
            {
                if (i >= 6) break;
                Guesses[i] = guess;
                i++;
                await InvokeAsync(StateHasChanged);
            }

            CurrentRow = Math.Min(6, guesses.Count);
            if (i > 0 && Guesses.Any(g => g?.Word.Equals(Solution, StringComparison.OrdinalIgnoreCase) == true))
                StatusMessage = $"Guesser solved in {i} steps.";
            else
                StatusMessage = $"Guesser produced {i} guess(es).";

            stats.robotCount = Guesses.Count(p => p != null);

            // final UI refresh
            await InvokeAsync(StateHasChanged);
        }
        catch (Exception ex)
        {

            StatusMessage = "AutoSolve failed: " + ex.Message;
            await InvokeAsync(StateHasChanged);
        }
    }
}
